# Практические сценарии для отработки собеседований

Ниже — подборка типовых задач, которые часто встречаются на live-coding и live-debug собеседованиях для Spring Boot / Kafka / JPA разработчиков. Каждая задача может оформляться отдельной веткой или issue, чтобы независимо воспроизводить баг и писать фикс.

## Транзакции и JPA
- **Rollback не срабатывает** — провал при публикации события или обращении к внешнему API не откатывает запись в БД. Проверьте `@Transactional` на сервисе и тип исключений.
- **Неправильная граница транзакции** — открытие транзакции в контроллере/REST слое, забытый `@Transactional` в асинхронном методе, `REQUIRES_NEW` вместо `REQUIRED`.
- **Ленивая загрузка вне транзакции** — `LazyInitializationException` при маппинге DTO. Решения: `fetch join`, `@EntityGraph`, транзакционные фасады.
- **Изоляция и блокировки** — потерянные обновления при параллельных резервациях, конфликты optimistic/pessimistic lock, несоответствующий `isolation` на `@Transactional`.

## Проблемы с запросами
- **N+1** — репозиторий возвращает сущности с ленивыми коллекциями, из-за чего идёт град SQL-запросов. Требуется `join fetch`, `@BatchSize` или отдельный запрос в репозитории.
- **Custom Query и модификации** — неправильное использование `@Modifying`, запросы без `clearAutomatically`, пропущенный `flush`, устаревший кэш `EntityManager`.
- **Миграции** — конфликт версий Liquibase, несовместимость SQL между H2 и PostgreSQL, неверная миграция типа (например, `timestamp` → `timestamptz`).
- **Перенос на jOOQ** — замена части запросов на jOOQ, несоответствие типов DTO, смешивание jOOQ и JPA в одной транзакции.

## Kafka и интеграции
- **Неверные generic-типы** — `KafkaTemplate<Object, Object>` против `KafkaTemplate<String, OrderCreatedEvent>`, ошибка бина и падение контекста.
- **Дублирующиеся бины** — два `ProducerFactory`, конфликт `@Primary`, использование `@Qualifier`.
- **Идempotentность** — повторная доставка сообщений, `ExactlyOnce` настройки, сохранение offsetов вне транзакции.

## Инфраструктура и конфигурация
- **Liquibase ошибки** — несовместимость changeSet с разными СУБД, конфликт checksum после ручного правления, перенос миграций между сервисами.
- **Профили и property overrides** — неправильная подстановка конфигурации, отсутствие `@ConfigurationProperties`, жёстко захардкоженные креды.
- **Обработка ошибок** — отсутствие `@ControllerAdvice`, неправильные HTTP-коды, неявные преобразования в ответах.

## Дополнительные темы
- **Кэширование** — `@Cacheable` без корректного `key`, кэширование ленивых коллекций, очистка кэша при изменении данных.
- **Тесты и фикстуры** — нестабильные интеграционные тесты, гонки в тестах с `@DirtiesContext`, MockKafka vs EmbeddedKafka.
- **Миграция БД** — пошаговое упражнение по переносу схемы с JPA/Hibernate на jOOQ или наоборот, сохранение совместимости API.

Каждый сценарий можно усилить отдельным «красным» тестом, который фиксирует поломку, и README-описанием шагов воспроизведения. Когда баг исправлен, ветку стоит мерджить в `baseline-clean` или архивировать для повторных тренировок.
